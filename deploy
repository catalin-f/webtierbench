#!/usr/bin/env python
from _base import _WEBTIER_VERSION
from _base import debugLogger
from _base import masterLogger
from _base import detect_os
from _base import Deployment
from _base import pickle_deployment
from _base import parse_deploy_args
from _base import load_deploy_configuration
from _base import save_deploy_configuration
from _apps import Apache2
from _apps import Perf
from _apps import ApacheBenchmark


def main():
    debugLogger("WebTier Benchmark version: %s" % _WEBTIER_VERSION)
    masterLogger("WebTier Benchmark version: %s" % _WEBTIER_VERSION)

    setup_json_filename = parse_deploy_args()

    # Parse JSON and save it locally
    try:
        config_json = load_deploy_configuration(setup_json_filename)
    except Exception as ex:
        #TODO should something else be done before crashing?
        raise ex
    save_deploy_configuration(config_json)

    distribution, version = detect_os()
    debugLogger("Host OS distribution: %s" % distribution)
    debugLogger("Host OS version: %s" % version)

    deployment = Deployment('mydeployment', distribution, version)

    out, err = deployment.common_host_setup()
    debugLogger("Common host setup stdout: %s" % out)
    debugLogger("Common host setup stderr: %s" % err)

    #TODO notify user to reboot station
    if deployment.reboot_required():
        print("These settings need a reboot! Please reboot the machine and run the deploy command again!")
        return 0

    apacheConfig = {
        "ip": "localhost",
        "port": "80"
    }
    abConfig = {
        "workers": 4,
        "requests": "1000",
        "endpoint": "http://localhost:80/index.html"
    }
    apache = Apache2(apacheConfig, distribution, version)
    perf = Perf({}, distribution, version)
    ab = ApacheBenchmark(abConfig, distribution, version)


    deployment.add_application(apache)
    debugLogger("Added application: apache2")

    deployment.add_perf(perf)
    debugLogger("Added performance measurement: perf")

    deployment.set_client(ab)
    debugLogger("Benchmark client: ab")

    out, err = deployment.deploy()
    debugLogger("Deployment stdout: %s " % out)
    debugLogger("Deployment stderr: %s " % err)

    pickle_deployment(deployment)
    debugLogger("Pickled deployment data")


if __name__ == '__main__':
    main()
